# Техническое задание: Happiness-Bot (MVP Telegram)

## 1. Цель и контекст
Создать Telegram‑бота, который помогает пользователю повышать субъективное благополучие через персонализированные практики и поддержку. Бот работает как коуч по благополучию, **не** является медицинским или психотерапевтическим сервисом.

## 2. Платформа и этапы
- **MVP:** Telegram‑бот (русский + английский), подписка через ЮKassa, админка.
- **Следующий этап:** мобильное приложение, внешние интеграции (HealthKit/Google Fit/Oura, календарь, погода), мультимодальность.
- **Хранение данных:** размещение в РФ не требуется, допускается облако за пределами РФ; требование должно быть конфигурируемым на уровне инфраструктуры.

## 3. Приоритеты (по скорости/простоте разработки)
### 3.1 MVP (Phase 1)
1) Онбординг + базовые диагностики (SHS, Person‑Activity Fit, Seligman 3 Lives).
2) Ежедневный цикл (check‑in → подбор практики → действие → награда).
3) Безопасность (SOS, red‑flags, anti‑sabotage, детектор гипомании).
4) Геймификация (AP, стрик, «дом» в текстовой метафоре).
5) Память и персонализация (вектор + JSON‑факты).
6) Админка (контент, промпты, лимиты/бюджеты OpenRouter, аналитика, биллинг).
7) Мультиязычность RU/EN.
8) Библиотека практик/микро‑обучения + RAG.

### 3.2 Phase 2 (после MVP)
- Глубокий VIA‑модуль (сильные стороны + job crafting).
- Flow‑engine (практики потока, deep work таймеры).
- Глубокий AI‑дневник (PERMA‑тегирование, weekly review).
- Генеративные визуализации (дом, книга жизни).
- Мультимодальность (голос/фото), TTS медитации.
- Внешние интеграции (HealthKit/Google Fit/Oura, календарь, погода).

## 4. Роли
- **Пользователь:** проходит онбординг, выполняет практики, ведет дневник.
- **Администратор:** управляет контентом, промптами, тарифами, лимитами OpenRouter, анализирует метрики.

## 5. Функциональные требования (MVP)
### 5.1 Онбординг и диагностика
- Приветствие + юридический дисклеймер.
- Возрастной гейт: подтверждение 18+; если нет — остановка сценария, нейтральное сообщение и рекомендации обратиться к взрослым/помощи.
- SHS (Subjective Happiness Scale, 4 вопроса) — фиксация точки A.
- Person‑Activity Fit: адаптированный диалог по стратегиям счастья (12 стратегий). Выход: топ‑3 стратегии пользователя.
- Seligman 3 Lives: оценка Pleasant/Good/Meaningful → присвоение статуса уровня.
- Краткий сбор профиля: имя, цель, доступное время, предпочитаемое время check‑in, язык, часовой пояс, страна (для SOS‑контактов).

### 5.2 Telegram UX и расписания
- Команды: `/start`, `/help`, `/sos`, `/pause`, `/resume`, `/settings`, `/language`.
- Кнопки: «Сделано», «Дай другое», «Пропустить сегодня», «Пауза».
- Настройки: частота чек‑ина (1–2 раза/день), время и тихие часы, смена языка.
- Часовой пояс берется из онбординга (Telegram не всегда передает его автоматически).

### 5.3 Ежедневный цикл (Daily Loop)
- **Trigger:** чек‑ин 1–2 раза в день (время настраиваемое).
- **Check‑in:** открытый вопрос (вариативные шаблоны).
- **AI‑анализ:**
  - Sentiment score (‑5..+5).
  - Keyword extraction (PERMA‑теги + стресс/усталость/смысл).
- **Matching Engine:** выбор практики по 3 факторам:
  1) текущее состояние (из check‑in),
  2) top‑3 стратегии (Person‑Activity Fit),
  3) уровень (Seligman).
- **Каталог практик:** каждая практика имеет метаданные: язык, стратегия, уровень, теги состояния (стресс/усталость/смысл), длительность, тип действия, интенсивность, противопоказания, cooldown.
- **Разнообразие:** запрет на повтор одной практики в течение N дней, приоритет новых/слабо использованных практик.
- **Практика:** короткая инструкция + «зачем» (1 фраза).
- **Ответ пользователя:** кнопка «Сделано» или краткий текст.
- **Reward:** +AP, стрик, короткая персональная похвала.
- **Опция «Дай другое»:** ограниченный reroll (например, 2 раза/день).

### 5.4 Anti‑sabotage
- Триггеры:
  - Ghosting > 48 часов.
  - Односложные ответы 3 дня подряд.
  - Прямые фразы сопротивления.
- Интервенции:
  - «Торг» (минимальная задача).
  - «Зеркало» (напоминание цели).
  - «Пивот» (смена типа практики).
- Режим «Отпуск» без чувства вины.

### 5.5 Safety (SOS + red flags)
- Команда `/sos` и ключевые фразы → протокол «первая помощь» (дыхание 4‑7‑8, 5‑4‑3‑2‑1).
- Red‑flags: признаки депрессии, селф‑харма, суицидальных мыслей.
- Детектор гипомании: ночная активность + гиперактивный стиль + грандиозные планы.
- При red‑flags: остановка коучинга, четкий дисклеймер, список горячих линий (по стране/языку).
- Для MVP список контактов: **Россия**. Для других стран — нейтральный совет обратиться в локальные службы экстренной помощи.

### 5.6 Память и персонализация
- **Короткая память:** 10–20 последних сообщений.
- **Суммаризация:** авто‑сводки, чтобы не переполнять контекст.
- **Векторная память:** смысловые фрагменты диалогов.
- **JSON‑факты:** ключевые сущности (имена, цели, предпочтения).
- **Правило:** в промпт попадают только релевантные фрагменты (top‑N), а не весь дневник.
- **Политика контекста:** суммаризация каждые N сообщений + жесткий лимит размера промпта.
- **Срок хранения:** настраиваемый TTL для сырых записей; обязательное удаление по запросу.
- **Редакция PII:** маскирование телефонов, email и адресов в векторной памяти.

### 5.7 Геймификация (минимальная)
- AP‑баллы за выполнение.
- Стрик дней без пропусков.
- Метафора «дом» в текстовом виде (фундамент/стены/крыша).

### 5.8 Мультиязычность
- RU/EN с отдельными шаблонами контента.
- Язык выбирается в онбординге, можно менять в настройках.
- Контент хранится по ключам, каждая сущность имеет RU/EN версии; отсутствие перевода блокируется в админке.

### 5.9 Подписка и биллинг
- Free‑tier + Trial + Premium.
- Trial: 7 дней полного доступа, активируется один раз после согласия пользователя, с автоконверсией в платный тариф при подтверждении оплаты; отключение в любой момент.
- Free‑tier (утверждено для MVP, настраивается в админке):
  - 1 чек‑ин в день.
  - До 3 практик в неделю.
  - Ограниченная история (7 дней) и упрощенные ответы без глубокого RAG.
- Premium (рекомендовано для MVP, цены в RUB, редактируются в админке):
  - **Monthly:** 499 ₽ / месяц.
  - **Annual:** 4 490 ₽ / год (≈25% скидка).
- Лимиты Premium: 2 чек‑ина в день, до 2 практик в день, полная история (12 месяцев), полный RAG; лимиты и длительность истории настраиваются в админке.
- ЮKassa: создание подписки, вебхуки оплаты/отмены, статусы trial/active/canceled.
- Блокировка Premium‑фич при отмене.
- Грейс‑период оплаты: 3 дня, затем downgrade в Free‑tier.

### 5.10 Админ‑панель (MVP)
- Управление:
  - контентом практик и тестов,
  - шаблонами чек‑ина,
  - промптами LLM,
  - лимитами и бюджетами OpenRouter,
  - расписаниями и сегментами пользователей,
  - тарифами и подписками.
- Аналитика: активность, retention, конверсия в подписку, причины оттока.
- RBAC (owner/editor/analyst/support) и аудит действий.

## 6. Контент и источники
- Контент и тесты берутся из открытых источников; фиксируется список лицензий/ссылок.
- RAG‑база формируется из книг (Селигман, Любомирски, Чиксентмихайи, Клир и др.).
- Контент в админке редактируемый и локализованный (RU/EN).

## 7. Интеграции (MVP)
- OpenRouter (LLM API).
- ЮKassa (подписки).
- OpenRouter политика: основной и резервный модели настраиваются в админке, таймауты/ретраи, graceful‑degradation (упрощенные шаблоны при ошибках/лимитах).

## 8. Интеграции (Phase 2 — для оценки)
- HealthKit, Google Fit, Oura.
- Календарь, погода, геолокация.
- Голос (voice biomarkers), фото (computer vision).
- Генеративные изображения (DALL‑E/Midjourney) и PDF «книга жизни».

## 9. Нефункциональные требования
- **Производительность:** ответ бота ≤ 6–8 сек при нормальной нагрузке.
- **Доступность:** 99%+ для MVP.
- **Безопасность:** шифрование конфиденциальных данных, доступ к админке по ролям.
- **Приватность:** возможность удалить данные пользователя по запросу.
- **Логи:** события безопасности фиксируются отдельно.
- **Соответствие:** соблюдение требований локального законодательства по данным.
- **Согласия:** явное согласие на обработку данных и условия сервиса при старте.
- **Экспорт:** по запросу пользователя выгрузка основных данных (профиль, практики, журнал).

## 10. Аналитика
- Основные метрики: DAU/WAU/MAU, retention D1/D7/D30, churn, conversion to paid.
- Контент‑метрики: top‑skipped практики, время ответа, средний sentiment‑score.
- Словарь событий (минимум): `onboarding_start`, `onboarding_done`, `checkin_sent`, `checkin_reply`, `practice_assigned`, `practice_done`, `trial_start`, `trial_convert`, `subscription_cancel`, `sos_trigger`.

## 11. Критерии приемки MVP
- Полный сценарий: онбординг → ежедневная практика → награда → стрик.
- Работают /sos и red‑flag протоколы.
- Персонализация по стратегиям и уровню.
- Админка меняет контент без релиза.
- Подписка через ЮKassa и ограничения free/premium.
- RU/EN переключение.

## 12. Оценка разработки (MVP)
### 12.1 Допущения
- Формат: in-house.
- Срок: 18–20 недель (4.5–5 месяцев), комфортный темп.
- Нагрузка: до 1000 пользователей на запуск.
- Админка: Production UI.
- Трудоемкость: 24–26 человеко‑месяцев.
- Ставка: 280–320 тыс ₽ за человеко‑месяц (all-in).

### 12.2 Итог по бюджету
- Базовая оценка MVP: 6.7–8.3 млн ₽.
- Плановый бюджет с резервом 10–15%: 7.5–9.2 млн ₽.
- Не включено: инфраструктура, комиссии ЮKassa, расходы на OpenRouter, закупка/лицензирование контента.

### 12.3 Разбивка по ролям (ориентир при 300 тыс ₽/чел‑мес и 4.75 мес)
| Роль | FTE | Чел‑мес | Сумма, млн ₽ |
| --- | --- | --- | --- |
| PM/BA | 0.6 | 2.9 | 0.9 |
| Backend | 1.2 | 5.7 | 1.7 |
| AI | 1.0 | 4.8 | 1.4 |
| Frontend (Admin) | 1.0 | 4.8 | 1.4 |
| QA | 0.7 | 3.3 | 1.0 |
| DevOps | 0.3 | 1.4 | 0.4 |
| Design | 0.3 | 1.4 | 0.4 |
| **Итого** | **5.1** | **24.3** | **7.3** |

Примечание: суммы масштабируются пропорционально ставке 280–320 тыс ₽/чел‑мес.

### 12.4 Оценка полного объема (исходный бриф, Phase 1 + Phase 2)
- MVP (Phase 1): 6.7–8.3 млн ₽.
- Phase 2 (мобильное приложение, интеграции, мультимодальность, генеративные визуалы): 8–14 млн ₽.
- **Итого полный объем:** 14.7–22.3 млн ₽ (без учета инфраструктуры и переменных затрат на API).

## 13. Открытые вопросы
- Открытых вопросов нет.
